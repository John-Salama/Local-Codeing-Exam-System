{% extends "base.html" %} {% block title %}Edit Exam - {{ exam.title }}{%
endblock %} {% block content %}
<div class="create-exam-container">
  <h2>Edit Exam: {{ exam.title }}</h2>

  <form
    method="POST"
    action="{{ url_for('edit_exam', exam_id=exam.id) }}"
    id="edit-exam-form"
    enctype="multipart/form-data"
  >
    <div class="form-group">
      <label for="title">Exam Title:</label>
      <input
        type="text"
        id="title"
        name="title"
        value="{{ exam.title }}"
        required
      />
    </div>

    <div class="form-group">
      <label for="duration">Duration (minutes):</label>
      <input
        type="number"
        id="duration"
        name="duration"
        min="1"
        value="{{ exam.duration }}"
        required
      />
    </div>

    {% if is_single_model %}
    <!-- Single Model Questions -->
    <div class="form-group model-questions" id="single-model-questions">
      <h3>Questions</h3>
      <div id="questions-container">
        {% for question in questions %}
        <div class="question-item" data-question-id="{{ question.id }}">
          <textarea
            name="question_{{ question.id }}"
            rows="3"
            class="question-textarea"
            placeholder="Enter question..."
            required
          >
{{ question.question_text }}</textarea
          >

          <div class="question-image-upload">
            <label>Question Image:</label>
            {% if question.image_path %}
            <div class="current-image">
              <img
                src="{{ url_for('static', filename=question.image_path) }}"
                alt="Current Image"
                class="question-image-preview"
              />
              <div>
                <label for="keep_image_{{ question.id }}">
                  <input
                    type="checkbox"
                    id="keep_image_{{ question.id }}"
                    name="keep_image_{{ question.id }}"
                    value="1"
                    checked
                  />
                  Keep this image
                </label>
              </div>
              <div>
                <label for="image_{{ question.id }}"
                  >Replace image (optional):</label
                >
                <input
                  type="file"
                  name="image_{{ question.id }}"
                  id="image_{{ question.id }}"
                  accept="image/*"
                  class="image-upload"
                />
              </div>
            </div>
            {% else %}
            <label for="image_{{ question.id }}">Add image (optional):</label>
            <input
              type="file"
              name="image_{{ question.id }}"
              id="image_{{ question.id }}"
              accept="image/*"
              class="image-upload"
            />
            {% endif %}
          </div>
          <button
            type="button"
            class="remove-question-btn"
            data-question-id="{{ question.id }}"
          >
            ×
          </button>
        </div>
        {% endfor %}
      </div>

      <button type="button" id="add-question-btn" class="button secondary">
        Add Another Question
      </button>
    </div>
    {% else %}
    <!-- Multiple Models -->
    <div class="models-tabs">
      <div class="tab-buttons">
        {% for model in models %}
        <button
          type="button"
          class="tab-button {% if loop.first %}active{% endif %}"
          data-model-id="{{ model.id }}"
        >
          {{ model.model_name }}
        </button>
        {% endfor %}
      </div>

      <div class="models-tab-content">
        {% for model in models %}
        <div
          class="model-content {% if loop.first %}active{% endif %}"
          id="model-{{ model.id }}-content"
        >
          <h3>{{ model.model_name }} Questions</h3>

          <div class="form-group">
            <label for="model_name_{{ model.id }}">Model Name:</label>
            <input
              type="text"
              id="model_name_{{ model.id }}"
              name="model_name_{{ model.id }}"
              value="{{ model.model_name }}"
              required
            />
          </div>

          <div
            class="questions-container"
            id="questions-container-{{ model.id }}"
          >
            {% for question in model_questions[model.id] %}
            <div class="question-item" data-question-id="{{ question.id }}">
              <textarea
                name="question_{{ model.id }}_{{ question.id }}"
                rows="3"
                class="question-textarea"
                placeholder="Enter question..."
                required
              >
{{ question.question_text }}</textarea
              >

              <div class="question-image-upload">
                <label>Question Image:</label>
                {% if question.image_path %}
                <div class="current-image">
                  <img
                    src="{{ url_for('static', filename=question.image_path) }}"
                    alt="Current Image"
                    class="question-image-preview"
                  />
                  <div>
                    <label for="keep_image_{{ question.id }}">
                      <input
                        type="checkbox"
                        id="keep_image_{{ question.id }}"
                        name="keep_image_{{ question.id }}"
                        value="1"
                        checked
                      />
                      Keep this image
                    </label>
                  </div>
                  <div>
                    <label for="image_{{ model.id }}_{{ question.id }}"
                      >Replace image (optional):</label
                    >
                    <input
                      type="file"
                      name="image_{{ model.id }}_{{ question.id }}"
                      id="image_{{ model.id }}_{{ question.id }}"
                      accept="image/*"
                      class="image-upload"
                    />
                  </div>
                </div>
                {% else %}
                <label for="image_{{ model.id }}_{{ question.id }}"
                  >Add image (optional):</label
                >
                <input
                  type="file"
                  name="image_{{ model.id }}_{{ question.id }}"
                  id="image_{{ model.id }}_{{ question.id }}"
                  accept="image/*"
                  class="image-upload"
                />
                {% endif %}
              </div>
              <button
                type="button"
                class="remove-question-btn"
                data-question-id="{{ question.id }}"
              >
                ×
              </button>
            </div>
            {% endfor %}
          </div>

          <button
            type="button"
            class="button secondary add-model-question-btn"
            data-model-id="{{ model.id }}"
          >
            Add Another Question
          </button>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <div class="form-actions">
      <button type="submit" class="button primary">Save Changes</button>
      <a href="{{ url_for('teacher_dashboard') }}" class="button">Cancel</a>
    </div>

    <input
      type="hidden"
      name="removed_questions"
      id="removed-questions"
      value=""
    />
  </form>
</div>
{% endblock %} {% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Track removed questions
    const removedQuestions = [];
    const removedQuestionsField = document.getElementById('removed-questions');

    // Handle removing questions
    document.querySelectorAll('.remove-question-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const questionId = this.getAttribute('data-question-id');
        removedQuestions.push(questionId);
        removedQuestionsField.value = removedQuestions.join(',');
        this.closest('.question-item').remove();
      });
    });

    {% if is_single_model %}
    // Single model - Add new questions
    const addQuestionBtn = document.getElementById("add-question-btn");
    const questionsContainer = document.getElementById("questions-container");

    if (addQuestionBtn) {
      addQuestionBtn.addEventListener("click", function () {
        const questionItem = document.createElement("div");
        questionItem.className = "question-item";
        questionItem.setAttribute('data-question-id', 'new_' + Date.now());

        const textarea = document.createElement("textarea");
        textarea.name = "new_question";
        textarea.rows = "3";
        textarea.className = "question-textarea";
        textarea.placeholder = "Enter question...";
        textarea.required = true;

        // Create image upload div
        const imageUploadDiv = document.createElement("div");
        imageUploadDiv.className = "question-image-upload";

        // Count existing questions for unique IDs
        const existingQuestions = questionsContainer.querySelectorAll(".question-item").length;
        const nextQuestionNum = existingQuestions + 1;

        // Create label for image upload
        const imageLabel = document.createElement("label");
        imageLabel.htmlFor = `new_image_${nextQuestionNum}`;
        imageLabel.textContent = "Add image (optional):";

        // Create file input for image
        const imageInput = document.createElement("input");
        imageInput.type = "file";
        imageInput.name = `new_image_${nextQuestionNum}`;
        imageInput.id = `new_image_${nextQuestionNum}`;
        imageInput.accept = "image/*";
        imageInput.className = "image-upload";

        // Add label and input to div
        imageUploadDiv.appendChild(imageLabel);
        imageUploadDiv.appendChild(imageInput);

        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.className = "remove-question-btn";
        removeBtn.textContent = "×";
        removeBtn.addEventListener("click", function () {
          questionItem.remove();
        });

        questionItem.appendChild(textarea);
        questionItem.appendChild(imageUploadDiv);
        questionItem.appendChild(removeBtn);
        questionsContainer.appendChild(questionItem);

        textarea.focus();
      });
    }
    {% else %}
    // Multiple models - Tab switching functionality
    const tabButtons = document.querySelectorAll(".tab-button");
    const modelContents = document.querySelectorAll(".model-content");

    tabButtons.forEach((button) => {
      button.addEventListener("click", function () {
        const modelId = this.getAttribute("data-model-id");

        // Remove active class from all buttons and contents
        tabButtons.forEach((btn) => btn.classList.remove("active"));
        modelContents.forEach((content) => content.classList.remove("active"));

        // Add active class to clicked button and corresponding content
        this.classList.add("active");
        document.getElementById(`model-${modelId}-content`).classList.add("active");
      });
    });

    // Add new question to a model
    document.querySelectorAll('.add-model-question-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const modelId = this.getAttribute('data-model-id');
        const questionsContainer = document.getElementById(`questions-container-${modelId}`);

        const questionItem = document.createElement("div");
        questionItem.className = "question-item";
        questionItem.setAttribute('data-question-id', 'new_' + Date.now());

        const textarea = document.createElement("textarea");
        textarea.name = `new_question_${modelId}`;
        textarea.rows = "3";
        textarea.className = "question-textarea";
        textarea.placeholder = "Enter question...";
        textarea.required = true;

        // Create image upload div
        const imageUploadDiv = document.createElement("div");
        imageUploadDiv.className = "question-image-upload";

        // Count existing questions for unique IDs
        const existingQuestions = questionsContainer.querySelectorAll(".question-item").length;
        const nextQuestionNum = existingQuestions + 1;

        // Create label for image upload
        const imageLabel = document.createElement("label");
        imageLabel.htmlFor = `new_image_${modelId}_${nextQuestionNum}`;
        imageLabel.textContent = "Add image (optional):";

        // Create file input for image
        const imageInput = document.createElement("input");
        imageInput.type = "file";
        imageInput.name = `new_image_${modelId}_${nextQuestionNum}`;
        imageInput.id = `new_image_${modelId}_${nextQuestionNum}`;
        imageInput.accept = "image/*";
        imageInput.className = "image-upload";

        // Add label and input to div
        imageUploadDiv.appendChild(imageLabel);
        imageUploadDiv.appendChild(imageInput);

        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.className = "remove-question-btn";
        removeBtn.textContent = "×";
        removeBtn.addEventListener("click", function () {
          questionItem.remove();
        });

        questionItem.appendChild(textarea);
        questionItem.appendChild(imageUploadDiv);
        questionItem.appendChild(removeBtn);
        questionsContainer.appendChild(questionItem);

        textarea.focus();
      });
    });
    {% endif %}
  });
</script>
{% endblock %}
